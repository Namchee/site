---
import "@/assets/styles/shiki.css";

import { parseDocument } from "htmlparser2";

import { codeToHtml, type BundledLanguage } from "shiki";
import { transformerNotationHighlight } from "@shikijs/transformers";

import CopyCode from "@/components/vue/CopyCode.vue";
import Clipboard from "@/components/astro/icons/Clipboard.astro";
import Check from "@/components/astro/icons/Check.astro";

type DataElement = {
  attribs: Record<string, string>;
  children: { data: string }[];
};

const html = await Astro.slots.render("default");
const document = parseDocument(html);

const { children, attribs } = document.children[0] as unknown as DataElement;

const text = children[0].data.trim();

const lang = attribs["class"]?.split("-")?.pop() || ("" as BundledLanguage);
const codeProps = {};

if (attribs["metastring"]) {
  attribs["metastring"].split(",").forEach((prop) => {
    const tokens = prop.split("=");
    codeProps[tokens[0].trim()] = tokens[1];
  });
}

const title = codeProps["title"];
const isCopyable = "copyable" in codeProps;
const noLang = "no-lang" in codeProps;

const htmlCode = await codeToHtml(text, {
  lang,
  themes: {
    light: "github-light",
    dark: "tokyo-night",
  },
  transformers: [transformerNotationHighlight()],
});
---

<figure
  class:list={[
    ":uno:",
    "my-4",
    "overflow-hidden",
    "border",
    "border-separator",
    "rounded-md",
    "transition-colors",
  ]}
>
  {
    (title || isCopyable) && (
      <figcaption class="flex justify-between items-center text-xs leading-normal border-separator bg-surface text-balance transition-colors p-2 px-4 border-b rounded-t-md">
        <p>{title}</p>

        {isCopyable && (
          <CopyCode code={text} client:visible>
            <Clipboard class=":uno: size-[14px] transition-colors text-content/70 group-hover:text-heading group-focus:text-heading flex-shrink-0" />

            <Check
              slot="copied"
              class=":uno: size-[14px] text-success flex-shrink-0"
            />
          </CopyCode>
        )}
      </figcaption>
    )
  }

  <div class="relative">
    <p
      class:list={[
        "absolute top-3 right-4 font-mono text-sm text-content/50",
        { hidden: noLang },
      ]}
    >
      {lang}
    </p>

    <Fragment set:html={htmlCode} />
  </div>
</figure>
